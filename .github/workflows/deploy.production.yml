name: Deploy Langfuse

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (e.g. staging, production)'
        required: true
        type: string

jobs:
  deploy-to-aks:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      AZURE_STORAGE_ACCOUNT_NAME: ${{ vars.AZURE_STORAGE_ACCOUNT_NAME }}
      AZURE_STORAGE_ACCOUNT_KEY: ${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
      ENVIRONMENT: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS context
        run: |
          az aks get-credentials \
            --resource-group TRPL-Prod-AKS \
            --name TRPL-Prod-Cluster \
            --overwrite-existing

      - name: Create namespace if needed
        run: |
          kubectl create namespace ${{ inputs.environment }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply image pull secret (if needed)
        run: |
          kubectl create secret docker-registry acr-pull-secret \
            --docker-server=${{ vars.ACR_NAME }}.azurecr.io \
            --docker-username=${{ vars.ACR_USERNAME }} \
            --docker-password=${{ secrets.ACR_PASSWORD }} \
            -n ${{ inputs.environment }} \
            --dry-run=client -o yaml | kubectl apply -f - || true

      # ðŸ”¹ Step 1: Download .env file from Azure Blob Storage
      - name: Download .env from Azure Blob
        run: |
          echo "Downloading .env for environment: ${ENVIRONMENT}"
          az storage blob download \
            --account-name "$AZURE_STORAGE_ACCOUNT_NAME" \
            --account-key "$AZURE_STORAGE_ACCOUNT_KEY" \
            --container-name trpl-agentic-framework-supervisor-agent \
            --name "${ENVIRONMENT}/.env" \
            --file .env
          echo "âœ… .env file downloaded successfully."

      # ðŸ”¹ Step 2: Create or update Kubernetes secret from .env
      - name: Create or update langfuse-env secret
        run: |
          echo "Updating secret langfuse-env in namespace ${{ inputs.environment }}"
          kubectl delete secret langfuse-env -n ${{ inputs.environment }} --ignore-not-found
          kubectl create secret generic langfuse-env \
            --from-env-file=.env \
            -n ${{ inputs.environment }}
          echo "âœ… Secret updated successfully."

      # ðŸ”¹ Step 3: Apply Kubernetes manifests
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/service.yaml -n ${{ inputs.environment }}
          kubectl apply -f k8s/ingress.yaml -n ${{ inputs.environment }}
          kubectl apply -f k8s/deployment.yaml -n ${{ inputs.environment }}
          kubectl apply -f k8s/worker-deployment.yaml -n ${{ inputs.environment }}
          kubectl apply -f k8s/clickhouse-service.yaml -n ${{ inputs.environment }}

      # ðŸ”¹ Step 4: Wait for deployment rollout
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/langfuse-web -n ${{ inputs.environment }} --timeout=5m
          kubectl rollout status deployment/langfuse-worker -n ${{ inputs.environment }} --timeout=5m
